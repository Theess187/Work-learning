---
- name: Установка и настройка Nginx
  hosts: webservers
  become: yes # нужен sudo для установки пакетов

  vars:
    http_port: 80
    server_name: "Shat_test"
    my_name: "Simon" # поменяй на своё имя, появится на странице

  tasks:
    # обновляем кэш apt перед установкой
    - name: Обновить кэш apt
      apt:
        update_cache: yes

    - name: Установить nginx
      apt:
        name: nginx
        state: present

    # копируем нашу html страницу на сервер
    - name: Задеплоить кастомную страницу
      template:
        src: templates/index.html.j2
        dest: /var/www/html/index.html
        mode: "0644"
      notify: Restart Nginx # перезапускаем nginx если страница изменилась

    # убеждаемся что nginx запущен и стартует при перезагрузке
    - name: Запустить nginx
      service:
        name: nginx
        state: started
        enabled: yes

    # просто смотрим статус - ничего не меняем
    - name: Проверить что nginx слушает порт {{ http_port }}
      shell: ss -tlnp | grep {{ http_port }}
      register: port_check
      changed_when: false # команда ничего не меняет

    - name: Вывести результат проверки порта
      debug:
        msg: "{{ port_check.stdout }}"

  handlers:
    - name: Restart Nginx
      service:
        name: nginx
        state: restarted
